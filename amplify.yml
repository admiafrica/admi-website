version: 1
backend:
  phases:
    build:
      commands:
        - '# Install dependencies for blog generation'
        - npm install
        - '# Install Serverless Framework globally'
        - npm install -g serverless
        - '# Deploy Lambda functions and EventBridge schedules'
        - cd infrastructure/serverless/blog-generation
        - npm install
        - |
          if [ "$AWS_BRANCH" = "main" ]; then
            echo "Deploying to staging..."
            ./deploy.sh staging --verbose
          elif [ "$AWS_BRANCH" = "staging" ]; then
            echo "Deploying to staging..."
            ./deploy.sh staging --verbose
          else
            echo "Deploying to development..."
            ./deploy.sh dev --verbose
          fi
        - cd ../../..
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
    build:
      commands:
        - echo "NODE_ENV=production" >> .env.production
        - echo "ADMI_CONTENTFUL_SPACE_ID=$ADMI_CONTENTFUL_SPACE_ID" >> .env.production
        - echo "ADMI_CONTENTFUL_ACCESS_TOKEN=$ADMI_CONTENTFUL_ACCESS_TOKEN" >> .env.production
        - echo "ADMI_CONTENTFUL_ENVIRONMENT=$ADMI_CONTENTFUL_ENVIRONMENT" >> .env.production
        - echo "BREVO_API_KEY=$BREVO_API_KEY" >> .env.production
        - echo "BREVO_LIST_ID=$BREVO_LIST_ID" >> .env.production
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*