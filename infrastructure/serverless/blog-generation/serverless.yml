service: admi-blog-generation

provider:
  name: aws
  runtime: nodejs18.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  timeout: 900 # 15 minutes for blog generation
  memorySize: 512
  environment:
    ADMI_CONTENTFUL_SPACE_ID: ${env:ADMI_CONTENTFUL_SPACE_ID, ''}
    ADMI_CONTENTFUL_ACCESS_TOKEN: ${env:ADMI_CONTENTFUL_ACCESS_TOKEN, ''}
    ADMI_CONTENTFUL_MANAGEMENT_TOKEN: ${env:CONTENTFUL_MANAGEMENT_TOKEN, ''}
    ADMI_CONTENTFUL_ENVIRONMENT: ${env:ADMI_CONTENTFUL_ENVIRONMENT, 'master'}
    OPENAI_API_KEY: ${env:NEXT_OPENAI_API_KEY, ''}
    YOUTUBE_API_KEY: ${env:YOUTUBE_API_KEY, ''}
    BLOG_GENERATION_WEBHOOK_URL: ${env:BLOG_GENERATION_WEBHOOK_URL, ''}
    APP_URL: ${env:APP_URL, 'https://dlm0hjalapt7d.amplifyapp.com'}
    CRON_SECRET: ${env:CRON_SECRET, 'admi-cron-secret-2025'}
    PERPLEXITY_API_KEY: ${env:PERPLEXITY_API_KEY, ''}
    FIRECRAWL_API_KEY: ${env:FIRECRAWL_API_KEY, ''}
    DATAFORSEO_LOGIN: ${env:DATAFORSEO_LOGIN, ''}
    DATAFORSEO_PASSWORD: ${env:DATAFORSEO_PASSWORD, ''}
    CONTENTFUL_SPACE_ID: ${env:CONTENTFUL_SPACE_ID, ''}
    CONTENTFUL_ENVIRONMENT: ${env:CONTENTFUL_ENVIRONMENT, 'master'}
    CONTENTFUL_ACCESS_TOKEN: ${env:CONTENTFUL_ACCESS_TOKEN, ''}
    CONTENTFUL_MANAGEMENT_TOKEN: ${env:CONTENTFUL_MANAGEMENT_TOKEN, ''}
    S3_BLOG_IMAGES_BUCKET: admi-blog-images-${self:provider.stage}
    IMAGE_PROVIDER: ${env:IMAGE_PROVIDER, 'disabled'}
    REPLICATE_API_TOKEN: ${env:REPLICATE_API_TOKEN, ''}
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: arn:aws:logs:*:*:*
        - Effect: Allow
          Action:
            - ssm:GetParameter
            - ssm:GetParameters
          Resource: arn:aws:ssm:${self:provider.region}:*:parameter/admi/blog/*
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:PutObjectAcl
            - s3:GetObject
            - s3:DeleteObject
          Resource: 
            - 'arn:aws:s3:::admi-blog-images-${self:provider.stage}/*'
            - 'arn:aws:s3:::admi-hero-images-${self:provider.stage}/*'
        - Effect: Allow
          Action:
            - cloudfront:CreateInvalidation
          Resource: '*'

functions:
  dailyBlogGeneration:
    handler: handlers/blogGeneration.daily
    description: Generate daily blog articles (2 articles)
    events:
      - schedule:
          rate: cron(0 5 * * ? *)  # Daily at 5:00 AM UTC (7:00 AM EAT)
          enabled: true
          input:
            type: daily
            count: 2
    reservedConcurrency: 1

  weeklyBlogGeneration:
    handler: handlers/blogGeneration.weekly
    description: Generate weekly blog articles (7 articles)
    events:
      - schedule:
          rate: cron(0 10 ? * SUN *)  # Weekly on Sunday at 10:00 AM UTC
          enabled: true
          input:
            type: weekly
            count: 7
    reservedConcurrency: 1

  testBlogGeneration:
    handler: handlers/blogGeneration.test
    description: Test blog generation function (manual trigger)
    events:
      - http:
          path: /test-blog-generation
          method: post
          cors: true

  blogStats:
    handler: handlers/blogGeneration.stats
    description: Get blog generation statistics
    events:
      - http:
          path: /blog-stats
          method: get
          cors: true

  videoCacheRefresh:
    handler: handlers/videoCacheRefresh.refresh
    description: Refresh video cache daily at 1 AM
    timeout: 600 # 10 minutes for video API calls
    events:
      - schedule:
          rate: cron(0 0 * * ? *)  # Daily at midnight UTC
          enabled: true
          input:
            type: cache_refresh
    reservedConcurrency: 1

  weeklyFaqOptimization:
    handler: handlers/faqGeneration.weeklyOptimize
    description: Weekly FAQ optimization using analytics data
    timeout: 600 # 10 minutes for FAQ generation
    events:
      - schedule:
          rate: cron(0 6 ? * MON *)  # Weekly on Monday at 6:00 AM UTC
          enabled: true
          input:
            type: weekly_optimize
    reservedConcurrency: 1

  dailyFaqGeneration:
    handler: handlers/faqGeneration.dailyGenerate
    description: Daily FAQ generation and Contentful sync
    timeout: 600 # 10 minutes for FAQ generation
    events:
      - schedule:
          rate: cron(0 2 * * ? *)  # Daily at 2:00 AM UTC
          enabled: true
          input:
            type: daily_faq
    reservedConcurrency: 1


plugins:
  - serverless-webpack
  - serverless-dotenv-plugin
  - serverless-offline

custom:
  webpack:
    webpackConfig: webpack.config.js
    includeModules: true
    packager: npm
  dotenv:
    path: .env
    exclude:
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY
      - AWS_SESSION_TOKEN
      - AWS_DEFAULT_REGION
      - AWS_PROFILE
      - AWS_ACCOUNT

package:
  exclude:
    - .git/**
    - .env.example
    - README.md
    - tests/**
    - node_modules/aws-sdk/**

resources:
  Resources:
    BlogImagesBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: admi-blog-images-${self:provider.stage}
        PolicyDocument:
          Statement:
            - Sid: PublicReadGetObject
              Effect: Allow
              Principal: '*'
              Action:
                - s3:GetObject
              Resource: 'arn:aws:s3:::admi-blog-images-${self:provider.stage}/blog-images/*'

  Outputs:
    BlogImagesBucketName:
      Description: Name of the S3 bucket for blog images
      Value: admi-blog-images-${self:provider.stage}
      Export:
        Name: ${self:service}-${self:provider.stage}-blog-images-bucket
    DailyBlogFunctionArn:
      Description: ARN of the daily blog generation function
      Value:
        Fn::GetAtt: [DailyBlogGenerationLambdaFunction, Arn]
      Export:
        Name: ${self:service}-${self:provider.stage}-daily-blog-arn

    WeeklyBlogFunctionArn:
      Description: ARN of the weekly blog generation function
      Value:
        Fn::GetAtt: [WeeklyBlogGenerationLambdaFunction, Arn]
      Export:
        Name: ${self:service}-${self:provider.stage}-weekly-blog-arn

    VideoCacheRefreshFunctionArn:
      Description: ARN of the video cache refresh function
      Value:
        Fn::GetAtt: [VideoCacheRefreshLambdaFunction, Arn]
      Export:
        Name: ${self:service}-${self:provider.stage}-video-cache-arn